name: CI

on:
  pull_request:
  push:
    branches:
      - master
      - main
      - refactor
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  backend-checks:
    name: Backend Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install backend dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt pytest

      - name: Validate Python sources compile
        run: |
          python -m compileall app tests

      - name: Validate tests collect
        run: |
          pytest --collect-only tests

  docker-build:
    name: Docker Build Validation
    runs-on: ubuntu-latest
    needs:
      - backend-checks
      # - frontend-checks

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate backend image build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.test
          push: false
          tags: nuclei-api-backend:ci

      - name: Validate fingerprint image build
        uses: docker/build-push-action@v6
        with:
          context: ./fingerprint-service
          file: ./fingerprint-service/Dockerfile
          push: false
          tags: nuclei-api-fingerprint:ci

      - name: Validate docker-compose file
        run: docker compose config --quiet

  integration-smoke:
    name: Integration Smoke (API + Redis + Celery)
    runs-on: ubuntu-latest
    needs:
      - docker-build

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Start stack for integration checks
        run: |
          docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d redis celery_worker nuclei-api

      - name: Wait for API readiness
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8000/ >/dev/null; then
              exit 0
            fi
            sleep 2
          done
          echo "API did not become ready in time"
          docker compose -f docker-compose.yml -f docker-compose.ci.yml logs nuclei-api
          exit 1

      - name: Install smoke test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run API smoke checks
        run: |
          set -euo pipefail
          python - <<'PY'
          import json
          import time
          import requests

          base_url = "http://localhost:8000"

          ping = requests.get(f"{base_url}/", timeout=30)
          ping.raise_for_status()
          assert ping.json().get("ping") == "pong!"

          invalid = requests.post(
              f"{base_url}/nuclei/scan",
              json={"target": "not-a-valid-target", "templates": ["cves/"]},
              timeout=30,
          )
          assert invalid.status_code == 400, invalid.text

          scan = requests.post(
              f"{base_url}/nuclei/scan",
              json={"target": "example.com", "templates": ["http/"]},
              timeout=60,
          )
          scan.raise_for_status()
          task_id = scan.json().get("task_id")
          assert task_id, scan.text

          final_status = None
          for _ in range(90):
              status = requests.get(f"{base_url}/nuclei/task/{task_id}", timeout=30)
              status.raise_for_status()
              payload = status.json()
              final_status = payload.get("status")
              if final_status in {"SUCCESS", "FAILURE"}:
                  break
              time.sleep(2)

          assert final_status in {"SUCCESS", "FAILURE"}, f"task stuck with status={final_status}"
          print(f"Smoke checks passed; task={task_id} status={final_status}")
          PY

      - name: Dump service logs on failure
        if: failure()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml logs --no-color

      - name: Stop stack
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml down -v
